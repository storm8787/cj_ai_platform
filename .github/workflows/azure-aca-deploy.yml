# Azure Container Apps ìë™ ë°°í¬ (GitHub Container Registry ì‚¬ìš©)
name: Azure Container Apps Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/cj-ai-backend
  RESOURCE_GROUP: rg-cj-ai-platform
  CONTAINERAPP_NAME: cj-ai-backend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # ghcr.io í‘¸ì‹œ ê¶Œí•œ
    
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest
      
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy to Container Apps
        run: |
          az containerapp update \
            --name ${{ env.CONTAINERAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
      
      - name: Verify Deployment
        run: |
          FQDN=$(az containerapp show \
            --name ${{ env.CONTAINERAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          echo "ğŸŒ App URL: https://$FQDN"
          
          # í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 5ë²ˆ ì¬ì‹œë„)
          for i in {1..5}; do
            if curl -sf "https://$FQDN/api/health" | grep -q "healthy"; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "â³ Waiting for app to be ready... ($i/5)"
            sleep 15
          done
          echo "âš ï¸ Health check timeout, but deployment completed"
